<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Foody — Регистрация ресторана</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#fff; --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --ok:#111; --err:#e11d48;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0f17; --fg:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --ok:#fff; }
      body{ background: #080c13; }
    }
    *{ box-sizing: border-box; }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
          margin:0; background:var(--bg); color:var(--fg); }
    .wrap{ max-width: 920px; margin: 0 auto; padding: 24px; }
    .header{ display:flex; align-items:center; gap:12px; margin-bottom: 12px; }
    .header h1{ font-size: 28px; margin:0; }
    .muted{ color: var(--muted); }
    .card{
      border:1px solid var(--line); border-radius:16px; padding:20px;
      box-shadow: 0 4px 14px rgba(0,0,0,.05);
      background: var(--bg);
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .row-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:16px; }
    label{ font-weight:600; font-size:14px; margin-bottom:6px; display:block; }
    input, textarea, select{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px;
      background: transparent; color: var(--fg);
    }
    input::placeholder, textarea::placeholder{ color: var(--muted); }
    .hint{ color:#8b9bb0; font-size:12px; }
    .actions{ display:flex; gap:12px; align-items:center; margin-top:20px; }
    button{
      padding:12px 16px; border-radius:12px; border:0; background: var(--ok);
      color:#fff; font-weight:600; cursor:pointer;
    }
    .ghost{ background: transparent; border:1px solid var(--line); color: var(--fg); }
    .error{
      margin-top: 12px; color: var(--err); font-size: 13px; display:none;
    }
    .success{
      margin-top: 12px; color: #16a34a; font-size: 13px; display:none;
    }
    .footnote{ margin-top:10px; font-size:13px; }
    a{ color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Регистрация ресторана</h1>
      <span class="muted">Создайте аккаунт и сразу переходите в личный кабинет</span>
    </div>

    <div class="card">
      <form id="regForm" autocomplete="on">
        <div class="row">
          <div>
            <label>Название ресторана</label>
            <input name="name" placeholder="Напр., «Sakura Bento»" required />
          </div>
          <div>
            <label>Телефон</label>
            <input name="phone" inputmode="tel" placeholder="+971..." />
          </div>
        </div>

        <div style="margin-top:16px;">
          <label>Адрес</label>
          <input name="address" placeholder="Город, улица, дом" />
        </div>

        <div class="row" style="margin-top:16px;">
          <div>
            <label>Email (логин)</label>
            <input name="email" type="email" placeholder="you@restaurant.com" required />
          </div>
          <div>
            <label>Пароль</label>
            <input name="password" type="password" minlength="6" placeholder="минимум 6 символов" required />
          </div>
        </div>

        <div class="actions">
          <button type="submit">Зарегистрироваться</button>
          <a class="ghost" href="/web/merchant/">В кабинет</a>
        </div>

        <div id="errBox" class="error"></div>
        <div id="okBox" class="success">Готово! Перенаправляю в кабинет…</div>

        <div class="footnote muted">
          Нажимая «Зарегистрироваться», вы соглашаетесь с условиями сервиса.
        </div>
      </form>
    </div>
  </div>

  <!-- window.foodyApi берём из /config.js -->
  <script src="/config.js"></script>
  <script>
    if (!window.foodyApi) {
      window.foodyApi = 'https://foodyback-production.up.railway.app';
    }

    function showError(msg){
      const el = document.getElementById('errBox');
      el.style.display = 'block';
      el.textContent = msg || 'Ошибка. Попробуйте ещё раз.';
      document.getElementById('okBox').style.display = 'none';
    }
    function showOk(msg){
      const ok = document.getElementById('okBox');
      ok.style.display = 'block';
      ok.textContent = msg || 'Успех';
      document.getElementById('errBox').style.display = 'none';
    }

    const form = document.getElementById('regForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = Object.fromEntries(new FormData(form).entries());

      // мини-валидация
      if (!payload.name || !payload.email || !payload.password) {
        showError('Заполните обязательные поля: название, email, пароль.');
        return;
      }

      try {
        const res = await fetch((window.foodyApi || '') + '/merchant/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(txt || ('HTTP ' + res.status));

        // если бэк отдаёт токен — можно сохранить, но это опционально:
        try {
          const data = JSON.parse(txt);
          if (data && data.token) localStorage.setItem('foody_token', data.token);
        } catch(_) {}

        showOk('Готово! Перенаправляю…');
        setTimeout(() => { location.href = '/web/merchant/'; }, 600);
      } catch (err) {
        console.error(err);
        // попытаемся вытащить message из JSON
        try{
          const d = JSON.parse(err.message);
          showError(d.detail || d.error || 'Ошибка регистрации');
        }catch(_){
          showError('Ошибка регистрации: ' + (err.message || ''));
        }
      }
    });
  </script>
</body>
</html>
